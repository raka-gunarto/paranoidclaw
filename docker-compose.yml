services:
  proxy:
    image: ghcr.io/raka-gunarto/agent-panopticon:0.2.0
    container_name: paranoidclaw-panopticon
    env_file: .env.proxy
    cap_add: [NET_ADMIN]
    ports:
      - "127.0.0.1:${INBOUND_HTTPS_PORT:-18789}:${INBOUND_HTTPS_PORT:-18789}"
      - "127.0.0.1:${DASHBOARD_PORT:-8081}:${DASHBOARD_PORT:-8081}"
    volumes:
      - mitmproxy-certs:/home/mitmuser/.mitmproxy
      - ./allowlist.txt:/etc/proxy/config/allowlist.txt:ro
    networks: [external]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    healthcheck:
      test: ["CMD-SHELL", "grep -q mitmweb /proc/1/cmdline"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  openclaw:
    build:
      context: .
      dockerfile: Dockerfile.openclaw-hardened
    container_name: paranoidclaw-openclaw
    env_file: .env.openclaw
    network_mode: "service:proxy"
    depends_on:
      proxy: { condition: service_healthy }
    user: "65532:65532"
    cap_drop: [ALL]
    security_opt: 
      - no-new-privileges:true
      - seccomp=openclaw-seccomp.json
      - apparmor=openclaw-apparmor
    read_only: true
    init: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    mem_limit: 2G
    cpus: 2.0
    pids_limit: 200
    volumes:
      - mitmproxy-certs:/mitmproxy-certs:ro
      - openclaw-persistence:/home/openclaw
    environment:
      REQUESTS_CA_BUNDLE: /mitmproxy-certs/mitmproxy-ca-cert.pem
      SSL_CERT_FILE: /mitmproxy-certs/mitmproxy-ca-cert.pem
      NODE_EXTRA_CA_CERTS: /mitmproxy-certs/mitmproxy-ca-cert.pem
    restart: unless-stopped
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "loopback",
        "--port",
        "18780",
        "--allow-unconfigured"
      ]

volumes:
  mitmproxy-certs:
  openclaw-persistence:

networks:
  external:
    driver: bridge
    enable_ipv6: false
